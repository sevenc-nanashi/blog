<!DOCTYPE html><html><head><meta charSet="utf-8"/><title>d.pyで複数のAudioSourceを同時に再生する | 名前のない日記｡</title><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="referrer" content="strict-origin"/><meta name="title" content="d.pyで複数のAudioSourceを同時に再生する | 名前のない日記｡"/><meta name="description" content="d.pyで複数のAudioSourceを同時に再生したかっただけ"/><meta name="theme-color" content="#48b0d5"/><link rel="shortcut icon" href="/favicon.ico"/><link rel="icon" href="/favicon.ico"/><meta name="next-head-count" content="9"/><link rel="preload" href="/_next/static/css/514d4d45e9a023fc.css" as="style"/><link rel="stylesheet" href="/_next/static/css/514d4d45e9a023fc.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-ee7e63bc15b31913.js" defer=""></script><script src="/_next/static/chunks/framework-3b5a00d5d7e8d93b.js" defer=""></script><script src="/_next/static/chunks/main-128443c28bd77875.js" defer=""></script><script src="/_next/static/chunks/pages/_app-6222d17004d613ae.js" defer=""></script><script src="/_next/static/chunks/605040ef-9aa4f587ac847b4e.js" defer=""></script><script src="/_next/static/chunks/pages/articles/dpy_mix_audio_source-e1053e937a4bb98f.js" defer=""></script><script src="/_next/static/RLDEIWNkOr-Y_3ym6hQMU/_buildManifest.js" defer=""></script><script src="/_next/static/RLDEIWNkOr-Y_3ym6hQMU/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="dark:bg-black"><div class="min-h-screen bg-theme-pale"><nav class="sticky flex items-center px-8 h-16 w-full flex-row bg-theme text-white shadow-[0_2px_4px_2px_rgb(0_0_0_/_0.1)]"><a href="/"><a class="text-xl font-bold">名前のない日記。</a></a><div class="ml-auto opacity-50 hover:opacity-100"><a href="https://github.com/sevenc-nanashi/blog" target="_blank" rel="noopener noreferrer">GitHub</a></div></nav><div class="flex flex-row p-8 justify-center h-full"><div class="flex justify-center items-center text-white lg:hidden fixed bottom-2 left-2 w-12 h-12 rounded-full bg-theme drop-shadow-2xl cursor-pointer"><svg fill="currentColor" class="___12fm75w f1w7gpdv fez10in fg4l7m0" aria-hidden="true" width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3.5 16.5a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3Zm4 .5H21a1 1 0 0 1 .12 2H7.5a1 1 0 0 1-.12-2H21 7.5Zm-4-6.5a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3Zm4 .5H21a1 1 0 0 1 .12 2H7.5a1 1 0 0 1-.12-2H21 7.5Zm-4-6.5a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3Zm4 .5H21a1 1 0 0 1 .12 2H7.5a1 1 0 0 1-.12-2H21 7.5Z" fill="currentColor"></path></svg></div><nav class="lg:min-w-[20%] lg:w-max w-screen h-screen lg:h-auto lg:min-h-full drop-shadow-xl lg:drop-shadow-none t-0 fixed lg:relative -translate-y-24 lg:-translate-y-0 pointer-events-none lg:pointer-events-auto transition-transform -translate-x-full lg:translate-x-0 false"><div class="lg:sticky w-full h-max top-8"><div class="flex flex-col content-bg rounded-r lg:rounded p-4 h-full lg:h-max fixed lg:relative top-0 left-0 -translate-x-full lg:translate-x-0 shadow-md lg:shadow-sm"><ul class="pl-4 lg:pl-0"><li class="text-theme text-2xl lg:text-xl font-bold"><a href="/articles/dpy_mix_audio_source/#root"><a>目次</a></a></li><li class="text-lg"><a href="/articles/dpy_mix_audio_source/#%E3%82%B3%E3%83%BC%E3%83%89"><a class="hover:text-theme">コード</a></a></li><li class="text-lg"><a href="/articles/dpy_mix_audio_source/#%E8%AA%AD%E3%81%BF%E4%B8%8A%E3%81%92"><a class="hover:text-theme">読み上げ</a></a></li><li class="text-lg"><a href="/articles/dpy_mix_audio_source/#%E3%81%A7%E3%80%81%E5%AE%9F%E7%94%A8%E6%80%A7%E3%81%AF%EF%BC%9F"><a class="hover:text-theme">で、実用性は？</a></a></li><li class="text-lg"><a href="/articles/dpy_mix_audio_source/#%E3%81%8A%E3%82%8F%E3%82%8A"><a class="hover:text-theme">おわり</a></a></li></ul></div></div></nav><main class="p-6 flex-grow content-bg rounded xl:mx-8 lg:ml-8"><h1 id="root" class="mb-2 pb-2 border-b-2">d.pyで複数のAudioSourceを同時に再生する</h1><article><p>４つ目の記事。<!-- --> <!-- -->同時再生読み上げBotというものを思いついたので作ってみた。</p><a href="/articles/dpy_mix_audio_source/#%E3%82%B3%E3%83%BC%E3%83%89"><a class="no-color"><h2 id="コード" class="heading">コード</h2></a></a><div class="code" aria-live="polite"><pre class="language-python">import audioop
import discord


class MixAudioSource(discord.AudioSource):
    def __init__(self) -&gt; None:
        super().__init__()
        self.sources = []

    def read(self) -&gt; bytes:
        data = bytes(3840)  # 3840バイトのバッファを作成
        for source in self.sources:  # ソースを回す
            if not (d := source.read()):  # 再生終了
                source.cleanup()
                self.sources.remove(source)
            else:  # 合成
                data = audioop.add(data, d, 2)
        return data
</pre></div><a href="/articles/dpy_mix_audio_source/#%E6%B3%A8%E6%84%8F"><a class="no-color"><h4 id="注意" class="heading">注意</h4></a></a><ul><li>常に再生中マークが出る</li><li>重ねれば重ねるほど音が大きくなる</li></ul><a href="/articles/dpy_mix_audio_source/#%E8%AA%AD%E3%81%BF%E4%B8%8A%E3%81%92"><a class="no-color"><h2 id="読み上げ" class="heading">読み上げ</h2></a></a><div class="code" aria-live="polite"><pre class="language-python">from os import getenv
import re
import discord
from discord.ext import commands
import aiohttp
import hashlib
import os
from dotenv import load_dotenv

from mix import MixAudioSource

load_dotenv()

bot = commands.Bot(command_prefix=&quot;!&quot;, intents=discord.Intents.all())
source = MixAudioSource()
voices = []


@bot.event
async def on_ready():
    global voices
    c: discord.VoiceClient = await bot.get_channel(int(getenv(&quot;DISCORD_VC_ID&quot;))).connect()
    c.play(source)
    async with aiohttp.ClientSession() as session:
        async with session.get(
            &quot;https://api.su-shiki.com/v2/voicevox/speakers/&quot;,
            params={&quot;key&quot;: getenv(&quot;VV_KEY&quot;)},
        ) as resp:
            voices = [j[&quot;styles&quot;][0][&quot;id&quot;] for j in await resp.json()]


@bot.event
async def on_message(message):
    if message.author.bot:
        return
    if message.channel.id != int(getenv(&quot;DISCORD_TC_ID&quot;)):
        return
    if not message.clean_content:
        return
    speaker = message.author.id % len(voices)
    print(f&quot;{message.author} : {speaker}&quot;)
    content = message.clean_content
    content = re.sub(r&quot;&lt;a?:([a-zA-Z_]+):\d+&gt;&quot;, r&quot;\1&quot;, content)
    content = re.sub(r&quot;https?://[^\s]+&quot;, r&quot;&quot;, content)
    txt_hash = hashlib.sha256(f&quot;{content}-{speaker}&quot;.encode(&quot;utf-8&quot;)).hexdigest()
    if not os.path.exists(f&quot;voice/{txt_hash}.wav&quot;):
        async with aiohttp.ClientSession() as session:
            async with session.get(
                &quot;https://api.su-shiki.com/v2/voicevox/audio&quot;,
                params={
                    &quot;text&quot;: content,
                    &quot;key&quot;: getenv(&quot;VV_KEY&quot;),
                    &quot;speaker&quot;: voices[speaker],
                    &quot;enable_interrogative_upspeak&quot;: &quot;true&quot;,
                },
            ) as resp:
                with open(f&quot;voice/{txt_hash}.wav&quot;, &quot;wb&quot;) as f:
                    f.write(await resp.read())

    source.sources.append(discord.FFmpegPCMAudio(f&quot;voice/{txt_hash}.wav&quot;))


bot.run(getenv(&quot;TOKEN&quot;))
</pre></div><p>面倒だったため、以下の機能が実装されていない：</p><ul><li>使い終わったファイルの削除</li><li>任意のチャンネルへの接続</li><li>VC外のユーザーの除外</li><li>辞書</li></ul><a href="/articles/dpy_mix_audio_source/#%E3%81%A7%E3%80%81%E5%AE%9F%E7%94%A8%E6%80%A7%E3%81%AF%EF%BC%9F"><a class="no-color"><h2 id="で、実用性は？" class="heading">で、実用性は？</h2></a></a><p>ない（断言）<br/>同時再生するとカオスになって面白くなるかな～？って思ってやった結果がこれだよ！</p><a href="/articles/dpy_mix_audio_source/#%E3%81%8A%E3%82%8F%E3%82%8A"><a class="no-color"><h2 id="おわり" class="heading">おわり</h2></a></a><p>読み上げと音楽再生を両方する的なことができそう。<br/>コードは自由に使ってください。<br/>おわり。</p></article></main><div class="w-1/5 hidden xl:block"></div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"markdoc":{"content":{"$$mdtype":"Tag","name":"article","attributes":{},"children":[{"$$mdtype":"Tag","name":"p","attributes":{},"children":["４つ目の記事。"," ","同時再生読み上げBotというものを思いついたので作ってみた。"]},{"$$mdtype":"Tag","name":"Heading","attributes":{"level":2,"id":"コード"},"children":["コード"]},{"$$mdtype":"Tag","name":"Fence","attributes":{"content":"import audioop\nimport discord\n\n\nclass MixAudioSource(discord.AudioSource):\n    def __init__(self) -\u003e None:\n        super().__init__()\n        self.sources = []\n\n    def read(self) -\u003e bytes:\n        data = bytes(3840)  # 3840バイトのバッファを作成\n        for source in self.sources:  # ソースを回す\n            if not (d := source.read()):  # 再生終了\n                source.cleanup()\n                self.sources.remove(source)\n            else:  # 合成\n                data = audioop.add(data, d, 2)\n        return data\n","language":"python"},"children":["import audioop\nimport discord\n\n\nclass MixAudioSource(discord.AudioSource):\n    def __init__(self) -\u003e None:\n        super().__init__()\n        self.sources = []\n\n    def read(self) -\u003e bytes:\n        data = bytes(3840)  # 3840バイトのバッファを作成\n        for source in self.sources:  # ソースを回す\n            if not (d := source.read()):  # 再生終了\n                source.cleanup()\n                self.sources.remove(source)\n            else:  # 合成\n                data = audioop.add(data, d, 2)\n        return data\n"]},{"$$mdtype":"Tag","name":"Heading","attributes":{"level":4,"id":"注意"},"children":["注意"]},{"$$mdtype":"Tag","name":"ul","attributes":{},"children":[{"$$mdtype":"Tag","name":"li","attributes":{},"children":["常に再生中マークが出る"]},{"$$mdtype":"Tag","name":"li","attributes":{},"children":["重ねれば重ねるほど音が大きくなる"]}]},{"$$mdtype":"Tag","name":"Heading","attributes":{"level":2,"id":"読み上げ"},"children":["読み上げ"]},{"$$mdtype":"Tag","name":"Fence","attributes":{"content":"from os import getenv\nimport re\nimport discord\nfrom discord.ext import commands\nimport aiohttp\nimport hashlib\nimport os\nfrom dotenv import load_dotenv\n\nfrom mix import MixAudioSource\n\nload_dotenv()\n\nbot = commands.Bot(command_prefix=\"!\", intents=discord.Intents.all())\nsource = MixAudioSource()\nvoices = []\n\n\n@bot.event\nasync def on_ready():\n    global voices\n    c: discord.VoiceClient = await bot.get_channel(int(getenv(\"DISCORD_VC_ID\"))).connect()\n    c.play(source)\n    async with aiohttp.ClientSession() as session:\n        async with session.get(\n            \"https://api.su-shiki.com/v2/voicevox/speakers/\",\n            params={\"key\": getenv(\"VV_KEY\")},\n        ) as resp:\n            voices = [j[\"styles\"][0][\"id\"] for j in await resp.json()]\n\n\n@bot.event\nasync def on_message(message):\n    if message.author.bot:\n        return\n    if message.channel.id != int(getenv(\"DISCORD_TC_ID\")):\n        return\n    if not message.clean_content:\n        return\n    speaker = message.author.id % len(voices)\n    print(f\"{message.author} : {speaker}\")\n    content = message.clean_content\n    content = re.sub(r\"\u003ca?:([a-zA-Z_]+):\\d+\u003e\", r\"\\1\", content)\n    content = re.sub(r\"https?://[^\\s]+\", r\"\", content)\n    txt_hash = hashlib.sha256(f\"{content}-{speaker}\".encode(\"utf-8\")).hexdigest()\n    if not os.path.exists(f\"voice/{txt_hash}.wav\"):\n        async with aiohttp.ClientSession() as session:\n            async with session.get(\n                \"https://api.su-shiki.com/v2/voicevox/audio\",\n                params={\n                    \"text\": content,\n                    \"key\": getenv(\"VV_KEY\"),\n                    \"speaker\": voices[speaker],\n                    \"enable_interrogative_upspeak\": \"true\",\n                },\n            ) as resp:\n                with open(f\"voice/{txt_hash}.wav\", \"wb\") as f:\n                    f.write(await resp.read())\n\n    source.sources.append(discord.FFmpegPCMAudio(f\"voice/{txt_hash}.wav\"))\n\n\nbot.run(getenv(\"TOKEN\"))\n","language":"python"},"children":["from os import getenv\nimport re\nimport discord\nfrom discord.ext import commands\nimport aiohttp\nimport hashlib\nimport os\nfrom dotenv import load_dotenv\n\nfrom mix import MixAudioSource\n\nload_dotenv()\n\nbot = commands.Bot(command_prefix=\"!\", intents=discord.Intents.all())\nsource = MixAudioSource()\nvoices = []\n\n\n@bot.event\nasync def on_ready():\n    global voices\n    c: discord.VoiceClient = await bot.get_channel(int(getenv(\"DISCORD_VC_ID\"))).connect()\n    c.play(source)\n    async with aiohttp.ClientSession() as session:\n        async with session.get(\n            \"https://api.su-shiki.com/v2/voicevox/speakers/\",\n            params={\"key\": getenv(\"VV_KEY\")},\n        ) as resp:\n            voices = [j[\"styles\"][0][\"id\"] for j in await resp.json()]\n\n\n@bot.event\nasync def on_message(message):\n    if message.author.bot:\n        return\n    if message.channel.id != int(getenv(\"DISCORD_TC_ID\")):\n        return\n    if not message.clean_content:\n        return\n    speaker = message.author.id % len(voices)\n    print(f\"{message.author} : {speaker}\")\n    content = message.clean_content\n    content = re.sub(r\"\u003ca?:([a-zA-Z_]+):\\d+\u003e\", r\"\\1\", content)\n    content = re.sub(r\"https?://[^\\s]+\", r\"\", content)\n    txt_hash = hashlib.sha256(f\"{content}-{speaker}\".encode(\"utf-8\")).hexdigest()\n    if not os.path.exists(f\"voice/{txt_hash}.wav\"):\n        async with aiohttp.ClientSession() as session:\n            async with session.get(\n                \"https://api.su-shiki.com/v2/voicevox/audio\",\n                params={\n                    \"text\": content,\n                    \"key\": getenv(\"VV_KEY\"),\n                    \"speaker\": voices[speaker],\n                    \"enable_interrogative_upspeak\": \"true\",\n                },\n            ) as resp:\n                with open(f\"voice/{txt_hash}.wav\", \"wb\") as f:\n                    f.write(await resp.read())\n\n    source.sources.append(discord.FFmpegPCMAudio(f\"voice/{txt_hash}.wav\"))\n\n\nbot.run(getenv(\"TOKEN\"))\n"]},{"$$mdtype":"Tag","name":"p","attributes":{},"children":["面倒だったため、以下の機能が実装されていない："]},{"$$mdtype":"Tag","name":"ul","attributes":{},"children":[{"$$mdtype":"Tag","name":"li","attributes":{},"children":["使い終わったファイルの削除"]},{"$$mdtype":"Tag","name":"li","attributes":{},"children":["任意のチャンネルへの接続"]},{"$$mdtype":"Tag","name":"li","attributes":{},"children":["VC外のユーザーの除外"]},{"$$mdtype":"Tag","name":"li","attributes":{},"children":["辞書"]}]},{"$$mdtype":"Tag","name":"Heading","attributes":{"level":2,"id":"で、実用性は？"},"children":["で、実用性は？"]},{"$$mdtype":"Tag","name":"p","attributes":{},"children":["ない（断言）",{"$$mdtype":"Tag","name":"br","attributes":{},"children":[]},"同時再生するとカオスになって面白くなるかな～？って思ってやった結果がこれだよ！"]},{"$$mdtype":"Tag","name":"Heading","attributes":{"level":2,"id":"おわり"},"children":["おわり"]},{"$$mdtype":"Tag","name":"p","attributes":{},"children":["読み上げと音楽再生を両方する的なことができそう。",{"$$mdtype":"Tag","name":"br","attributes":{},"children":[]},"コードは自由に使ってください。",{"$$mdtype":"Tag","name":"br","attributes":{},"children":[]},"おわり。"]}]},"frontmatter":{"title":"d.pyで複数のAudioSourceを同時に再生する","summary":"d.pyで複数のAudioSourceを同時に再生したかっただけ","tags":["discord.py","Python"]},"file":{"path":"/articles/dpy_mix_audio_source.md"}}},"__N_SSG":true},"page":"/articles/dpy_mix_audio_source","query":{},"buildId":"RLDEIWNkOr-Y_3ym6hQMU","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>